class Animation{move(e){return new Promise(t=>{const i=window.helper.getTranslateValue(e.target),n=Math.floor(i.y),a=Math.floor(i.x),o=void 0===e.vertical?n:Math.floor(e.vertical),r=void 0===e.horizontal?a:Math.floor(e.horizontal),s=void 0===e.speed?window.player.speed:e.speed,l=void 0===e.easing?"linear":e.easing;e.target.animate([{transform:`translate(${a}px, ${n}px)`},{transform:`translate(${r}px, ${o}px)`}],{duration:s,iterations:1,easing:l,fill:"both"}).onfinish=function(e){t(e)}})}}window.animation=new Animation;class Backpack{}window.backpack=new Backpack;class Camera{center(){const e=window.helper.getTranslateValue(window.interface.elPlayer);this.update(),window.animation.move({target:window.interface.elCamera,vertical:this.centerVertical(e),horizontal:this.centerHorizontal(e),speed:0})}centerHorizontal(e){const t=Number(-e.x+window.interface.elGameWidth/2-window.map.tileSizeHalf);return this.centerLimit(t,this.limit.centerHorizontal)}centerVertical(e){const t=Number(-e.y+window.interface.elGameHeight/2-window.map.tileSizeHalf);return this.centerLimit(t,this.limit.centerVertical)}centerLimit(e,t){return e<t?t:e>0?0:e}move(e){window.player.verifyWalk(e)||window.player.isMoving||(window.player.move(e),this.moveCamera(e))}moveCamera(e){const t=this.limit[e],i=window.helper.capitalize(e),n=window.helper.getTranslateValue(window.interface.elCamera);this[`verifyLimit${i}`]({limit:t,currentPosition:n})||this.moveCameraAnimate({side:e,currentPosition:n})}moveCameraAnimate(e){const t=e.currentPosition.x,i=e.currentPosition.y;let n,a={target:window.interface.elCamera};switch(e.side){case"down":n=Math.round(i-this.distance),Math.abs(window.camera.limit.down)-Math.abs(i)<this.distance&&(n=window.camera.limit.down),a.vertical=n;break;case"left":n=Math.round(t+this.distance),Math.abs(t)<this.distance&&(n=window.camera.limit.left),a.horizontal=n;break;case"up":n=Math.round(i+this.distance),Math.abs(n)<=this.distance&&(n=this.limit.up),a.vertical=n;break;case"right":n=Math.round(t-this.distance),window.interface.elGameWidth/2-this.distance-Math.abs(t)<this.distance&&(n=-1*window.camera.limit.right),a.horizontal=n}window.animation.move(a)}update(){this.distance=window.map.tileSize,this.limit={centerVertical:Number(-(window.map.height-window.interface.elGameHeight)),centerHorizontal:Number(-(window.map.width-window.interface.elGameWidth)),up:0,down:-1*Math.abs(window.map.tileSize*window.map.json.row-window.interface.elGameHeight),left:0,right:window.map.tileSize*window.map.json.column-window.interface.elGameWidth}}verifyLimitDown(e){const t=e.currentPosition.y;return e.limit>t}verifyLimitLeft(e){const t=e.currentPosition.x;return!(e.limit>t)}verifyLimitRight(e){const t=Math.abs(e.currentPosition.x);return e.limit<t}verifyLimitUp(e){const t=e.currentPosition.y;return e.limit<t}}window.camera=new Camera;class Craft{}window.craft=new Craft;class Data{constructor(){this.folderDefault="./api/"}loadMap(e){const t={controller:`${this.apiUrl}map-${e}.${this.extension}`};window.helper.ajax(t).then(e=>{window.map.buildMap(e)}).then(()=>{this.loadPlayer()}).then(()=>{window.enemy.build(),this.save()})}loadPlayer(){window.player.isInitial?(window.player.isInitial=!1,this.loadPlayerInitial()):window.loadingMain.hide()}loadPlayerInitial(){const e={controller:`${this.apiUrl}player.${this.extension}`};window.helper.ajax(e).then(e=>{window.player.buildPlayer(e)})}save(){const e={controller:`${this.apiUrl}save.${this.extension}`};window.helper.ajax(e).then(e=>{console.log(e)})}update(e){this.extension=e.extension,this.dataBase=e.extension,this.apiUrl=`${this.folderDefault+this.extension}/`}}window.data=new Data;class Enemy{constructor(){this.cssEnemy="enemy"}build(){this.enemyLength=window.map.json.enemy.quantity;const e=this.buildHtml();this.elEnemy.innerHTML=e,this.setPosition()}buildHtml(){let e="";for(let t=0;t<this.enemyLength;t++){let i=window.helper.raffleArray(window.map.json.enemy.kind);e+=`\n                <div id="${this.cssEnemy}_${t}" class="${this.cssEnemy} ${this.cssEnemy}--${i} tile center">\n                    Enemy ${t}\n                </div>\n            `}return e}setPosition(){for(let e=0;e<this.enemyLength;e++){const t=document.querySelector(`#${this.cssEnemy}_${e}`),i=window.map.rafflePosition();window.map.position({target:t,position:i})}}update(){this.elEnemy=document.querySelector(`#${this.cssEnemy}`)}}window.enemy=new Enemy;class Game{initialize(){window.data.loadMap(window.map.current)}}window.game=new Game;class Helper{ajax(e){return new Promise((t,i)=>{let n=new XMLHttpRequest;const a=void 0===e.kind?"GET":e.kind;n.open(a,e.controller,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onload=(()=>{n.status>=200&&n.status<300?t(n.responseText):i(n.statusText)}),n.onerror=(()=>i(n.statusText)),n.send(e.parameter)})}capitalize(e){return e.charAt(0).toUpperCase()+e.slice(1)}getOffset(e){if(!e)return;const t=e.getBoundingClientRect();return{top:t.top,right:t.right,bottom:t.bottom,left:t.left}}getTranslateValue(e){const t=window.getComputedStyle(e).transform;if("none"===t)return{x:0,y:0,z:0};const i=t.includes("3d")?"3d":"2d",n=t.match(/matrix.*\((.+)\)/)[1].split(", ");return"2d"===i?{x:Number(n[4]),y:Number(n[5]),z:0}:"3d"===i?{x:Number(n[12]),y:Number(n[13]),z:Number(n[14])}:void 0}raffleNumber(e){return e.minimum+Math.round((e.maximum-e.minimum)*Math.random())}raffleArray(e){return e[Math.floor(Math.random()*e.length)]}remove(e){null!==e&&e.parentNode.removeChild(e)}}window.helper=new Helper;class Interface{build(){this.update(),this.resize(),this.buildAction(),this.buildDirection()}buildAction(){this.elActionBackpack.onclick=(()=>{window.modal.open("backpack")}),this.elActionCraft.onclick=(()=>{window.modal.open("craft")}),this.elActionPick.onclick=(()=>{window.player.pick()}),this.elActionHit.onclick=(()=>{window.player.hit()})}buildDirection(){this.elDirectionalUp.onclick=(()=>{window.camera.move("up")}),this.elDirectionalDown.onclick=(()=>{window.camera.move("down")}),this.elDirectionalLeft.onclick=(()=>{window.camera.move("left")}),this.elDirectionalRight.onclick=(()=>{window.camera.move("right")})}update(){this.elCamera=document.querySelector("#camera"),this.elGame=document.querySelector("#game"),this.elMap=document.querySelector("#map"),this.elPlayer=document.querySelector("#player"),this.elBarLife=document.querySelector('[data-id="bar-life"]'),this.elBarHunger=document.querySelector('[data-id="bar-hunger"]'),this.elBarThirst=document.querySelector('[data-id="bar-thirst"]'),this.elActionBackpack=document.querySelector('[data-id="action-backpack"]'),this.elActionCraft=document.querySelector('[data-id="action-craft"]'),this.elActionPick=document.querySelector('[data-id="action-pick"]'),this.elActionHit=document.querySelector('[data-id="action-hit"]'),this.elDirectionalUp=document.querySelector('[data-id="directional-up"]'),this.elDirectionalDown=document.querySelector('[data-id="directional-down"]'),this.elDirectionalLeft=document.querySelector('[data-id="directional-left"]'),this.elDirectionalRight=document.querySelector('[data-id="directional-right"]')}updateBar(){this.elBarLife.setAttribute("value",player.lifeCurrent),this.elBarLife.setAttribute("max",player.life),this.elBarHunger.setAttribute("value",player.hungerCurrent),this.elBarHunger.setAttribute("max",player.hunger),this.elBarThirst.setAttribute("value",player.thirstCurrent),this.elBarThirst.setAttribute("max",player.thirst)}resize(){this.elGameWidth=this.elGame.offsetWidth,this.elGameHeight=this.elGame.offsetHeight}}window.interface=new Interface;class Keyboard{build(){document.addEventListener("keydown",e=>{this.buildAction(e.key)})}buildAction(e){switch(e){case"Up":case"ArrowUp":case"w":window.camera.move("up");break;case"Left":case"ArrowLeft":case"a":window.camera.move("left");break;case"Down":case"ArrowDown":case"s":window.camera.move("down");break;case"Right":case"ArrowRight":case"d":window.camera.move("right");break;case"Escape":window.modal.close()}}}window.keyboard=new Keyboard;class LoadingMain{constructor(){this.cssHide="hide",this.cssAnimation="animate"}update(){this.elWrapper=document.querySelector(".loading-main"),this.elLoading=this.elWrapper.querySelector(".loading")}hide(){this.elWrapper.classList.add(this.cssHide),this.elLoading.classList.remove(this.cssAnimation)}show(){this.elWrapper.classList.remove(this.cssHide),this.elLoading.classList.add(this.cssAnimation)}}window.loadingMain=new LoadingMain;class Map{constructor(){this.current=1,this.json={},this.arr=[],this.arrWalkFalse=[0],this.arrDoor=[2],this.arrForbidden=[],this.tileSize=50,this.tileSizeHalf=this.tileSize/2,this.tileId=0,this.tileIdPrefix="tile_",this.tileTotal=0}buildMap(e){this.json=JSON.parse(e),this.width=this.tileSize*this.json.column,this.height=this.tileSize*this.json.row,window.camera.update(),this.update(),this.convertArray(),this.buildHtml(),window.enemy.build(),window.resource.build(),window.player.isInitial||window.player.position()}buildHtml(){const e=this.buildHtmlRow();window.interface.elMap.style.width=`${this.width}px`,window.interface.elMap.style.height=`${this.height}px`,window.interface.elMap.innerHTML="",window.interface.elMap.insertAdjacentHTML("afterbegin",e)}buildHtmlRow(){let e="";for(let t=0;t<this.json.row;t++)e+=this.buildHtmlColumn(t);return e}buildHtmlColumn(e){let t="";for(let i=0;i<this.json.column;i++){let n=this.arr[e][i],a=Number(n.trim()),o=this.arrWalkFalse.includes(a),r=this.arrDoor.includes(a);(o||r)&&this.arrForbidden.push(this.tileId),t+=`<div class="tile tile--${a}" data-tile="${a}" id="${this.tileIdPrefix}${this.tileId}"></div>`,this.tileId++}return t}convertArray(){const e=this.json.map,t=Object.keys(e).length;for(let i=0;i<t;i++){let t=e[i].split(",");this.arr[i]=t}}change(){const e=window.player.tileCurrent,t=window.map.json.position;let i,n;window.loadingMain.show();for(let a in t)t.hasOwnProperty(a)&&t[a].tile===e&&(i=t[a].sendToMap,n=t[a].sendToTile);this.update(),window.player.tileCurrent=n,window.data.loadMap(i)}position(e){const t=e.target;if(!t)return;const i=this.tileIdPrefix+e.position,n=document.querySelector(`#${i}`),a=window.helper.getOffset(n),o=window.helper.getOffset(window.interface.elCamera),r={top:a.top-o.top,left:a.left-o.left};window.animation.move({target:t,vertical:Math.round(r.top),horizontal:Math.round(r.left),speed:0})}rafflePosition(){let e=this.rafflePositionRandom();for(;this.arrForbidden.includes(e);)e=this.rafflePositionRandom();return this.arrForbidden.push(e),e}rafflePositionRandom(){return window.helper.raffleNumber({minimum:0,maximum:window.map.tileTotal})}verifyDoor(e){return this.verifyTile({tile:e,arr:"arrDoor"})}verifyWalk(e){return this.verifyTile({tile:e,arr:"arrWalkFalse"})}verifyTile(e){const t=document.querySelector(`#${this.tileIdPrefix}${e.tile}`),i=Number(t.getAttribute("data-tile"));return!!this[e.arr].includes(i)}update(){this.tileId=0,this.tileTotal=window.map.json.row*window.map.json.column,this.arrForbidden=[]}}window.map=new Map;class Modal{constructor(){this.cssModal="modal",this.cssClose=`${this.cssModal}--close`,this.cssHide="hide"}build(){this.update(),this.buildAction()}buildAction(){this.elCloseButton.onclick=(()=>{this.close()})}close(){this.hidePage(),this.elModal.classList.add(this.cssClose)}open(e){const t=document.querySelector(`#page_${e}`);this.hidePage(),this.elModal.classList.remove(this.cssClose),t.classList.remove(this.cssHide)}hidePage(){Array.prototype.forEach.call(this.elPage,e=>{e.classList.contains(this.cssHide)||e.classList.add(this.cssHide)})}update(){this.elModal=document.querySelector(`.${this.cssModal}`),this.elContent=document.querySelector(`.${this.cssModal}__content`),this.elPage=this.elContent.querySelectorAll(".page"),this.elCloseButton=document.querySelector("#modal_close")}}window.modal=new Modal;class Player{constructor(){this.speed=0,this.isMoving=!1,this.isInitial=!0}buildPlayer(e){this.buildVariable(e),window.interface.updateBar(),this.position(),window.loadingMain.hide()}buildVariable(e){const t=JSON.parse(e);this.life=t.life,this.lifeCurrent=t.lifeCurrent,this.hunger=t.hunger,this.hungerCurrent=t.hungerCurrent,this.thirst=t.thirst,this.thirstCurrent=t.thirstCurrent,this.tileCurrent=window.map.json.position.player,this.speed=t.speed}hit(){console.log("hit")}move(e){const t=this.moveCoordinates(e);let i,n={target:window.interface.elPlayer};const a=void 0!==t.tileNext?n.tileNext=t.tileNext:void 0;void 0!==t.vertical&&(n.vertical=t.vertical),void 0!==t.horizontal&&(n.horizontal=t.horizontal),this.isMoving||(this.isMoving=!0,(i=window.animation.move(n)).then(()=>this.moveSuccess({tileNext:a,side:e})))}moveSuccess(e){const t=window.map.verifyDoor(e.tileNext);this.updatePosition({tileNext:e.tileNext,side:e}),t&&window.map.change()}moveCoordinates(e){const t=window.map.json.column,i=window.helper.getTranslateValue(window.interface.elPlayer);let n={};switch(e){case"up":n.tileNext=this.tileCurrent-t,n.vertical=i.y-window.camera.distance;break;case"down":n.tileNext=this.tileCurrent+t,n.vertical=i.y+window.camera.distance;break;case"left":n.tileNext=this.tileCurrent-1,n.horizontal=i.x-window.camera.distance;break;case"right":n.tileNext=this.tileCurrent+1,n.horizontal=i.x+window.camera.distance}return n}position(){window.map.position({target:window.interface.elPlayer,position:this.tileCurrent}),window.camera.center()}pick(){console.log("pick")}updatePosition(e){switch(this.isMoving=!1,this.tileCurrent=e.tileNext,e.side){case"up":this.currentVertical-=window.map.tileSize;break;case"down":this.currentVertical+=window.map.tileSize;break;case"left":this.currentHorizontal-=window.map.tileSize;break;case"right":this.currentHorizontal+=window.map.tileSize}}verifyWalk(e){const t=this.moveCoordinates(e);let i={target:window.interface.elPlayer};const n=void 0!==t.tileNext?i.tileNext=t.tileNext:void 0;return window.map.verifyWalk(n)}}window.player=new Player;class Resource{constructor(){this.cssResource="resource",this.cssItem="item"}build(){this.resourceLength=window.map.json.resource.quantity;const e=this.buildHtml();this.elItem.innerHTML=e,this.setPosition()}buildHtml(){let e="";for(let t=0;t<this.resourceLength;t++){let i=window.helper.raffleArray(window.map.json.resource.kind);e+=`\n                <div id="${this.cssItem}_${t}" class="${this.cssItem} ${this.cssItem}--${i} tile center">\n                    Item ${t}\n                </div>\n            `}return e}setPosition(){for(let e=0;e<this.resourceLength;e++){const t=document.querySelector(`#${this.cssItem}_${e}`),i=window.map.rafflePosition();window.map.position({target:t,position:i})}}update(){this.elItem=document.querySelector(`#${this.cssResource}`)}}window.resource=new Resource,document.addEventListener("DOMContentLoaded",()=>{window.data.update({extension:"js",dataBase:"localStorage"}),window.loadingMain.update(),window.modal.build(),window.map.update(),window.interface.build(),window.enemy.update(),window.resource.update(),window.keyboard.build(),window.game.initialize()}),window.addEventListener("resize",()=>{window.interface.resize(),window.camera.center()});
